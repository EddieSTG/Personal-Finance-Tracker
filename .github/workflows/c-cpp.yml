name: Cross-platform C++ CI (C++11)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # --------------------
      # Linux dependencies
      # --------------------
      - name: Install build tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y build-essential

      # --------------------
      # Windows (MSYS2)
      # --------------------
      - name: Setup MSYS2 + MinGW (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true

      - name: Install MinGW toolchain (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: pacman -S --noconfirm --needed mingw-w64-x86_64-toolchain

      # --------------------
      # Debug: show files
      # --------------------
      - name: Show repo files (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: ls -la

      - name: Show repo files (non-Windows)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: ls -la

      - name: Install Git (Windows / MSYS2)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: pacman -S --noconfirm --needed git


      # --------------------
      # Build (Windows)
      # --------------------
      - name: Build CLI with C++11 (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          mkdir -p bin
          export PATH="/mingw64/bin:$PATH"
          CXX=g++

          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(git ls-files -z '*.cpp')

          if [ ${#files[@]} -eq 0 ]; then
            echo "No .cpp files detected."
            exit 1
          fi

          "$CXX" -std=c++11 -O2 -Wall -Wextra -pthread -o bin/pft.exe "${files[@]}"

      # --------------------
      # Build (Linux/macOS)
      # --------------------
      - name: Build CLI with C++11 (non-Windows)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bin

          if [ "$RUNNER_OS" = "Linux" ]; then
            CXX=g++
          else
            CXX=clang++
          fi

          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(git ls-files -z '*.cpp')

          if [ ${#files[@]} -eq 0 ]; then
            echo "No .cpp files detected."
            exit 1
          fi

          "$CXX" -std=c++11 -O2 -Wall -Wextra -pthread -o bin/pft "${files[@]}"

      # --------------------
      # Smoke test
      # --------------------
      - name: Smoke test (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          if [ -x bin/pft.exe ]; then
            bin/pft.exe || true
          else
            echo "Executable not found"
            exit 1
          fi

      - name: Smoke test (non-Windows)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          if [ -x bin/pft ]; then
            ./bin/pft || true
          else
            echo "Executable not found"
            exit 1
          fi
