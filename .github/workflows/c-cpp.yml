name: Cross-platform C++ CI (C++11)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install build tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Show repo files
        run: ls -la

      - name: Build CLI with C++11
        run: |
          set -euo pipefail
          mkdir -p bin
          if [ "${RUNNER_OS}" = "Linux" ]; then
            CXX=g++
          else
            CXX=clang++
          fi
          files=$(git ls-files '*.cpp' | tr '\n' ' ')
          if [ -z "$files" ]; then
            echo "No .cpp files detected. Nothing to build."
            exit 1
          fi
          echo "Using compiler: $CXX"
          echo "Compiling sources: $files"
          $CXX -std=c++11 -O2 -Wall -Wextra -pthread -o bin/pft $files
          echo "Built: $(file bin/pft || true)"

      - name: Run smoke test
        run: |
          if [ -x bin/pft ]; then
            echo "Binary exists; running basic invocation (non-fatal)."
            ./bin/pft --help || ./bin/pft -h || ./bin/pft || true
          else
            echo "No binary found; skipping."
          fi
