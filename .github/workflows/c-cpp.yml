name: Cross-platform C++ CI (C++11)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install build tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Show repo files
        run: ls -la

      - name: Build CLI with C++11
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bin
          if [ "${RUNNER_OS}" = "Linux" ]; then
            CXX=g++
          else
            CXX=clang++
          fi

          # Collect .cpp sources safely (handles spaces/newlines in filenames)
          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(git ls-files -z '*.cpp')

          if [ ${#files[@]} -eq 0 ]; then
            echo "No .cpp files detected. Nothing to build."
            exit 1
          fi

          echo "Using compiler: $CXX"
          printf 'Compiling sources:\n'
          for f in "${files[@]}"; do printf '  %s\n' "$f"; done

          # Pass file list as array so filenames with spaces are preserved
          "$CXX" -std=c++11 -O2 -Wall -Wextra -pthread -o bin/pft "${files[@]}"
          echo "Built: $(file bin/pft || true)"
