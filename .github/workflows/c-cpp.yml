name: Xcode C/C++ CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Show repo files
        run: ls -la

      - name: List Xcode schemes (for debugging)
        run: xcodebuild -list -project "Personal Finance Tracker.xcodeproj" || true

      - name: Build using detected shared scheme
        env:
          PROJECT: "Personal Finance Tracker.xcodeproj"
        run: |
          set -euo pipefail
          # Extract shared schemes from xcodebuild output
          schemes=$(xcodebuild -list -project "$PROJECT" | awk '/Schemes:/{show=1; next} show && NF==0{exit} show{print}' | sed 's/^[[:space:]]*//')
          if [ -z "$schemes" ]; then
            echo "No shared schemes found. Make sure you've shared the scheme in Xcode (Product → Scheme → Manage Schemes → check 'Shared') and committed the xcshareddata/xcschemes file."
            exit 1
          fi
          SCHEME=$(printf "%s\n" "$schemes" | head -n1)
          echo "Using scheme: $SCHEME"
          # Build
          xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Release -sdk macosx BUILD_DIR=build clean build

      - name: Optional: Run tests (if you have test targets)
        if: always()
        env:
          PROJECT: "Personal Finance Tracker.xcodeproj"
        run: |
          set -euo pipefail
          schemes=$(xcodebuild -list -project "$PROJECT" | awk '/Schemes:/{show=1; next} show && NF==0{exit} show{print}' | sed 's/^[[:space:]]*//')
          if [ -z "$schemes" ]; then
            echo "No shared schemes; skipping tests."
            exit 0
          fi
          SCHEME=$(printf "%s\n" "$schemes" | head -n1)
          # Run tests on macOS platform (adjust destination if needed)
          xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Release -destination 'platform=macOS' test || true
